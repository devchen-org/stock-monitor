<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票持仓收益实时监控</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
        }
        .stock-table {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stock-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .positive {
            color: #dc3545;
        }
        .negative {
            color: #28a745;
        }
        .neutral {
            color: #6c757d;
        }
        .refresh-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .total-section {
            background-color: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .nav-link {
            cursor: pointer;
        }
        .nav-link.active {
            font-weight: bold;
        }
        .page-content {
            min-height: 600px;
        }
    </style>
</head>
<body>
    <div id="app" class="container mt-4">
        <h1 class="text-center mb-4">股票持仓收益实时监控</h1>
        
        <!-- 导航菜单 -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: activePage === 'dashboard' }" @click="activePage = 'dashboard'">持仓监控</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: activePage === 'holdings' }" @click="activePage = 'holdings'">持仓管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: activePage === 'settings' }" @click="activePage = 'settings'">系统设置</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: activePage === 'wechat' }" @click="activePage = 'wechat'">微信通知</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- 页面内容 -->
        <div class="page-content">
            <!-- 持仓监控页面 -->
            <div v-if="activePage === 'dashboard'">
                <!-- 状态信息 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span v-if="isRefreshing" class="refresh-indicator me-2"></span>
                            <span>{{ lastUpdated }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary btn-sm me-2" @click="refreshData">手动刷新</button>
                        <button class="btn btn-success btn-sm" @click="sendWechatMessage">发送到企业微信</button>
                    </div>
                </div>
                
                <!-- 非交易时间提示 -->
                <div v-if="nonTradingMessage" class="alert alert-warning mb-4" role="alert">
                    {{ nonTradingMessage }}
                </div>
                
                <!-- 股票表格 -->
                <div class="card stock-table mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">持仓列表</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>代码</th>
                                    <th>名称</th>
                                    <th>涨跌</th>
                                    <th>涨跌幅</th>
                                    <th>最高价</th>
                                    <th>最低价</th>
                                    <th>现价</th>
                                    <th>成本价</th>
                                    <th>买{{ settings.buy_lots }}手后成本价</th>
                                    <th>卖{{ settings.sell_lots }}手后成本价</th>
                                    <th>持仓</th>
                                    <th>市值</th>
                                    <th>盈亏额</th>
                                    <th>盈亏率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="holding in holdings" :key="holding.id">
                                    <td>{{ holding.code }}</td>
                                    <td>{{ holding.stockInfo?.name || holding.name || '-' }}</td>
                                    <td :class="getChangeClass(holding.stockInfo?.change || 0)">
                                        {{ formatChange(holding.stockInfo?.change || 0) }}
                                    </td>
                                    <td :class="getChangeClass(holding.stockInfo?.changePercent || 0)">
                                        {{ formatPercent(holding.stockInfo?.changePercent || 0) }}
                                    </td>
                                    <td>{{ holding.stockInfo?.high || '-' }}</td>
                                    <td>{{ holding.stockInfo?.low || '-' }}</td>
                                    <td>{{ holding.stockInfo?.now || '-' }}</td>
                                    <td>{{ holding.cost }}</td>
                                    <td>{{ holding.stockInfo ? formatNumber(calculateNewCostAfterBuy(holding, holding.stockInfo.now, settings.buy_lots)) : '-' }}</td>
                                    <td>{{ holding.stockInfo ? formatNumber(calculateNewCostAfterSell(holding, holding.stockInfo.now, settings.sell_lots)) : '-' }}</td>
                                    <td>{{ holding.shares }}</td>
                                    <td>{{ holding.profitInfo?.[0] || '-' }}</td>
                                    <td :class="getChangeClass(holding.profitInfo?.[1] || 0)">
                                        {{ formatChange(holding.profitInfo?.[1] || 0) }}
                                    </td>
                                    <td :class="getChangeClass(holding.profitInfo?.[2] || 0)">
                                        {{ formatPercent(holding.profitInfo?.[2] || 0) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 总计信息 -->
                <div class="total-section">
                    <h5 class="mb-2">总计</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>总市值:</strong> {{ formatNumber(total.marketValue) }}
                        </div>
                        <div class="col-md-3">
                            <strong>总成本:</strong> {{ formatNumber(total.cost) }}
                        </div>
                        <div class="col-md-3" :class="getChangeClass(total.profit)">
                            <strong>总盈亏:</strong> {{ formatChange(total.profit) }}
                        </div>
                        <div class="col-md-3" :class="getChangeClass(total.profitRate)">
                            <strong>总盈亏率:</strong> {{ formatPercent(total.profitRate) }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 持仓管理页面 -->
            <div v-if="activePage === 'holdings'">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">持仓管理</h5>
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addHoldingModal">添加持仓</button>
                    </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>代码</th>
                                    <th>名称</th>
                                    <th>持仓数量</th>
                                    <th>成本价</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="holding in holdings" :key="holding.id">
                                    <td>{{ holding.code }}</td>
                                    <td>{{ holding.stockInfo?.name || holding.name || '-' }}</td>
                                    <td>{{ holding.shares }}</td>
                                    <td>{{ holding.cost }}</td>
                                    <td>
                                        <button class="btn btn-outline-secondary btn-sm me-1" @click="editHolding(holding)">编辑</button>
                                        <button class="btn btn-outline-danger btn-sm" @click="deleteHolding(holding.id)">删除</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 系统设置页面 -->
            <div v-if="activePage === 'settings'">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">系统配置</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">API接口</label>
                                    <select v-model="settings.api_type" class="form-select" @change="updateSetting('api_type', settings.api_type)">
                                        <option value="sina">新浪</option>
                                        <option value="tencent">腾讯</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">刷新间隔 (秒)</label>
                                    <input type="number" v-model.number="settings.refresh_interval" class="form-control" min="1" @change="updateSetting('refresh_interval', settings.refresh_interval)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">只在交易时间刷新</label>
                                    <div class="form-check">
                                        <input type="checkbox" v-model="settings.trading_time" class="form-check-input" @change="updateSetting('trading_time', settings.trading_time ? 'true' : 'false')">
                                        <label class="form-check-label">启用</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">企业微信Webhook</label>
                                    <input type="text" v-model="settings.wechat_webhook" class="form-control" @change="updateSetting('wechat_webhook', settings.wechat_webhook)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">买入手数</label>
                                    <input type="number" v-model.number="settings.buy_lots" class="form-control" min="1" @change="updateSetting('buy_lots', settings.buy_lots)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">卖出手数</label>
                                    <input type="number" v-model.number="settings.sell_lots" class="form-control" min="1" @change="updateSetting('sell_lots', settings.sell_lots)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 微信通知页面 -->
            <div v-if="activePage === 'wechat'">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">微信通知设置</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label">企业微信Webhook</label>
                            <input type="text" v-model="settings.wechat_webhook" class="form-control" @change="updateSetting('wechat_webhook', settings.wechat_webhook)">
                            <small class="form-text text-muted">请输入企业微信机器人的Webhook地址</small>
                        </div>
                        <div class="mb-4">
                            <h6>发送测试消息</h6>
                            <p>点击下方按钮发送测试消息到企业微信，验证配置是否正确。</p>
                            <button class="btn btn-primary" @click="sendWechatMessage">发送测试消息</button>
                        </div>
                        <div class="mb-4">
                            <h6>通知内容说明</h6>
                            <p>每次自动刷新后，系统会将当前持仓情况发送到企业微信，包括股票名称、涨跌、涨跌幅、现价和成本价。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 添加持仓模态框 -->
        <div class="modal fade" id="addHoldingModal" tabindex="-1" aria-labelledby="addHoldingModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addHoldingModalLabel">添加持仓</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">股票代码</label>
                            <input type="text" v-model="newHolding.code" class="form-control" placeholder="例如：sh600519">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">股票名称</label>
                            <input type="text" v-model="newHolding.name" class="form-control" placeholder="可选">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">持仓数量</label>
                            <input type="number" v-model.number="newHolding.shares" class="form-control" min="0.01" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">成本价</label>
                            <input type="number" v-model.number="newHolding.cost" class="form-control" min="0.01" step="0.01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="addHolding">保存</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 编辑持仓模态框 -->
        <div class="modal fade" id="editHoldingModal" tabindex="-1" aria-labelledby="editHoldingModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editHoldingModalLabel">编辑持仓</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">股票代码</label>
                            <input type="text" v-model="editingHolding.code" class="form-control" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">股票名称</label>
                            <input type="text" v-model="editingHolding.name" class="form-control" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">持仓数量</label>
                            <input type="number" v-model.number="editingHolding.shares" class="form-control" min="0.01" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">成本价</label>
                            <input type="number" v-model.number="editingHolding.cost" class="form-control" min="0.01" step="0.01">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="updateHolding">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                activePage: 'dashboard',
                holdings: [],
                total: {
                    marketValue: 0,
                    cost: 0,
                    profit: 0,
                    profitRate: 0
                },
                settings: {
                    api_type: 'sina',
                    refresh_interval: 5,
                    trading_time: false,
                    wechat_webhook: '',
                    buy_lots: 1,
                    sell_lots: 1
                },
                isRefreshing: false,
                lastUpdated: '',
                nonTradingMessage: '',
                refreshTimer: null,
                newHolding: {
                    code: '',
                    name: '',
                    shares: 0,
                    cost: 0
                },
                editingHolding: {
                    id: 0,
                    code: '',
                    name: '',
                    shares: 0,
                    cost: 0
                }
            },
            mounted() {
                this.loadSettings();
                this.refreshData();
                this.startAutoRefresh();
            },
            methods: {
                // 加载配置
                loadSettings() {
                    fetch('api/index.php/settings')
                        .then(response => response.json())
                        .then(data => {
                            // 将字符串值转换为正确的类型
                            if (data.trading_time) {
                                data.trading_time = data.trading_time === 'true';
                            }
                            if (data.refresh_interval) {
                                data.refresh_interval = parseInt(data.refresh_interval);
                            }
                            if (data.buy_lots) {
                                data.buy_lots = parseInt(data.buy_lots);
                            }
                            if (data.sell_lots) {
                                data.sell_lots = parseInt(data.sell_lots);
                            }
                            this.settings = { ...this.settings, ...data };
                        });
                },
                
                // 刷新数据
                refreshData() {
                    this.isRefreshing = true;
                    fetch('api/index.php/stock-data')
                        .then(response => response.json())
                        .then(data => {
                            this.holdings = data.holdings;
                            this.total = data.total;
                            this.nonTradingMessage = data.nonTradingMessage;
                            this.lastUpdated = data.timestamp;
                            this.isRefreshing = false;
                        })
                        .catch(() => {
                            this.isRefreshing = false;
                        });
                },
                
                // 自动刷新
                startAutoRefresh() {
                    // 清除之前的定时器
                    if (this.refreshTimer) {
                        clearInterval(this.refreshTimer);
                    }
                    // 启动新的定时器
                    this.refreshTimer = setInterval(() => {
                        this.refreshData();
                    }, this.settings.refresh_interval * 1000);
                },
                
                // 更新配置
                updateSetting(key, value) {
                    fetch('api/index.php/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ key, value })
                    })
                    .then(() => {
                        // 如果是刷新间隔设置变化，重新启动自动刷新
                        if (key === 'refresh_interval') {
                            this.startAutoRefresh();
                        }
                        // 刷新数据以获取最新设置
                        this.refreshData();
                    });
                },
                
                // 添加持仓
                addHolding() {
                    fetch('api/index.php/holdings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.newHolding)
                    })
                    .then(() => {
                        const addModal = bootstrap.Modal.getInstance(document.getElementById('addHoldingModal'));
                        addModal.hide();
                        this.newHolding = { code: '', name: '', shares: 0, cost: 0 };
                        this.refreshData();
                    });
                },
                
                // 编辑持仓
                editHolding(holding) {
                    this.editingHolding = { ...holding };
                    const editModal = new bootstrap.Modal(document.getElementById('editHoldingModal'));
                    editModal.show();
                },
                
                // 更新持仓
                updateHolding() {
                    fetch('api/index.php/holdings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.editingHolding)
                    })
                    .then(() => {
                        const editModal = bootstrap.Modal.getInstance(document.getElementById('editHoldingModal'));
                        editModal.hide();
                        this.refreshData();
                    });
                },
                
                // 删除持仓
                deleteHolding(id) {
                    if (confirm('确定要删除这个持仓吗？')) {
                        fetch('api/index.php/holdings', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ id })
                        })
                        .then(() => {
                            this.refreshData();
                        });
                    }
                },
                
                // 发送企业微信消息
                sendWechatMessage() {
                    // 生成表格内容
                    let content = "股票持仓收益实时监控 - " + new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) + "\n\n";
                    content += "+----------------+----------+----------+----------+----------+\n";
                    content += "| 名称           | 涨跌     | 涨跌幅   | 现价     | 成本价   |\n";
                    content += "+----------------+----------+----------+----------+----------+\n";
                    
                    this.holdings.forEach(holding => {
                        if (holding.stockInfo) {
                            const info = holding.stockInfo;
                            const name = info.name;
                            const change = (info.change > 0 ? '+' : '') + info.change.toFixed(2);
                            const changePercent = info.changePercent.toFixed(2) + '%';
                            const now = info.now.toFixed(2);
                            const cost = holding.cost.toFixed(2);
                            
                            content += `| ${name.padEnd(14)} | ${change.padEnd(8)} | ${changePercent.padEnd(8)} | ${now.padEnd(8)} | ${cost.padEnd(8)} |\n`;
                        }
                    });
                    
                    content += "+----------------+----------+----------+----------+----------+\n";
                    
                    fetch('api/index.php/wechat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content })
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                    });
                },
                
                // 格式化数字
                formatNumber(num) {
                    return num.toFixed(2);
                },
                
                // 格式化涨跌
                formatChange(num) {
                    return (num > 0 ? '+' : '') + num.toFixed(2);
                },
                
                // 格式化百分比
                formatPercent(num) {
                    return num.toFixed(2) + '%';
                },
                
                // 获取涨跌颜色类
                getChangeClass(value) {
                    if (value > 0) return 'positive';
                    if (value < 0) return 'negative';
                    return 'neutral';
                },
                
                // 计算买x手后成本价
                calculateNewCostAfterBuy(holding, currentPrice, lots) {
                    const sharesToBuy = lots * 100;
                    const currentCostValue = holding.shares * holding.cost;
                    const newShares = holding.shares + sharesToBuy;
                    const newCostValue = currentCostValue + (sharesToBuy * currentPrice);
                    return newShares > 0 ? newCostValue / newShares : 0;
                },
                
                // 计算卖x手后成本价
                calculateNewCostAfterSell(holding, currentPrice, lots) {
                    const sharesToSell = lots * 100;
                    const newShares = Math.max(0, holding.shares - sharesToSell);
                    if (newShares <= 0) {
                        return 0;
                    }
                    const currentCostValue = holding.shares * holding.cost;
                    return currentCostValue / newShares;
                }
            }
        });
    </script>
</body>
</html>